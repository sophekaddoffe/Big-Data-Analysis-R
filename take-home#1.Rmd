---
title: "Take-home Assignment #1"
author: "Jakob Berg and Sophia Grill"
date: "handed out on 2020-06-29; to be handed in on 2020-07-06 at latest"
output: html_document
---

1. Acquire the dataset by running the following chunk. Install the missing packages first if necessary. I commented the code for you to show you some web-scraping and how you should comment your code.

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(rvest)
library(tidyverse)
url <- "https://www.nu3.de/blogs/nutrition/food-carbon-footprint-index-2018" # url to scrape

# scrape the website
url_html <- read_html(url) # read the page

# extract the HTML table
whole_table <- url_html %>% 
  html_nodes('table') %>% # select table
  html_table(fill = TRUE) %>% # parse it to date frame
  .[[1]] # pull out the data frame

table_content <- whole_table %>%
  select(-X1) %>% # remove redundant column
  filter(!dplyr::row_number() %in% 1:3) # remove redundant rows

raw_headers <- url_html %>%
  html_nodes(".thead-icon") %>% # select element 
  html_attr('title') # pull out column names

tidy_bottom_header <- raw_headers[28:length(raw_headers)]

raw_middle_header <- raw_headers[17:27]

tidy_headers <- c( # fix headers
  rep(raw_middle_header[1:7], each = 2),
  "animal_total",
  rep(raw_middle_header[8:length(raw_middle_header)], each = 2),
  "non_animal_total",
  "country_total")

combined_colnames <- paste(tidy_headers, tidy_bottom_header, sep = ';') # create column names
colnames(table_content) <- c("Country", combined_colnames) # add column names
table_content_tbl <- as_tibble(table_content)
table_content_tbl
```

2. Make the dataset tidy. Ask yourself the following questions: which variables does it contain? How can I put them into separate rows? 
3. Change the column names so that they do not have to be surrounded by backticks (i.e., they should only consist of lowercase characters, numbers, dots, and underscores).

```{r}
long_table <- table_content %>%  
 tidyr::pivot_longer(cols = -Country, names_to = "Category", values_to = "Values") %>%  
 separate(col = Category, into = c("Food Category", "Metric"), sep = ';')

tidy_table <- long_table %>%
   pivot_wider(names_from = Metric, values_from = Values) 


final_table <- tidy_table %>%
 rename(consumption = `Supplied for Consumption (kg/person/year)`,
        co2_emmission = `Kg CO2/person/year`,
        country = Country,
        food_category = `Food Category`) %>%
 drop_na()

head(final_table, 40)

```


4. Coerce variables to factors (if it makes sense). 
```{r}

# final_table <- mutate_if(final_table, is.character, as.factor)
# fctr useful for country, because it's arranged due to co2_emmission (descending)

final_table <- mutate_at(final_table, vars(country, food_category), as.factor)
final_table <- mutate_at(final_table, vars(consumption, co2_emmission), as.numeric)
head(final_table)

```

5. Visualize your dataset with `ggplot2`.
    a. A scatter plot with `consumption` on the x and `kg_co2` on the y axis. Color the dots according to `country`.
    
    ```{r}
 
ggplot(data = final_table) +
  geom_point(aes(x = consumption, y = co2_emmission, color = country))
    

    
    ```
  
    
```{r}

    
library(countrycode)
#df <- data.frame(country = c("Afghanistan",
                            # "Algeria",
                            # "USA",
                            # "France",
                            # "New Zealand",
                            # "Fantasyland"))

final_table$continent <- countrycode(sourcevar = final_table[, "country"],
                            origin = "country.name",
                            destination = "continent")

head(final_table)

```

```{r}

final_table_df <- as.data.frame(final_table)

  
library(countrycode)
#df <- data.frame(country = c("Afghanistan",
                            # "Algeria",
                            # "USA",
                            # "France",
                            # "New Zealand",
                            # "Fantasyland"))

final_table_df$continent <- countrycode(sourcevar = final_table_df[, "country"],
                            origin = "country.name",
                            destination = "continent")

head(final_table_df)

```
    
    
    
    ```{r}
 
ggplot(data = final_table_df) +
  geom_point(aes(x = consumption, y = co2_emmission, color = continent)) +
      labs(x="Consumption in kg per Person per Year", y= "CO2 Emmission in kg per Person per Year",
       title="CO2 Emmission vs Food Consumption")+
  theme_bw(base_size = 16)
    

    
    ```    



    
    b. A smoothed line with the same variables (no country-specific color coding though).
    
```{r}
ggplot(data = final_table) +
  geom_smooth(aes(x = consumption, y = co2_emmission)) +
      labs(x="Consumption in kg per Person per Year", y= "CO2 Emmission in kg per Person per Year",
       title="CO2 Emmission vs Food Consumption")+
  theme_bw(base_size = 16)
    
```
    
    c. Faceted graphs according to type of food.
    
    
    ```{r}
    
ggplot(data = final_table) +
  geom_point(aes(x = consumption, y = co2_emmission)) +
  facet_wrap(~food_category, nrow = 3) #+
      #scale_x_continuous() +
      #scale_y_continuous()
    
    
    ```

```{r}
final_table %>%    
ggplot(aes (x = consumption, y = co2_emmission)) +
  geom_point(alpha=0.3) + 
  labs(x="Food Consumption in kg per Person per Year", y= "CO2 Emission in kg per person per Year",
       title="CO2 emission vs Food Consumption") +
  scale_y_continuous()+
  scale_x_continuous()+
  geom_smooth(method=lm,se=FALSE)+
  facet_wrap(~food_category, ncol=4)+
  theme_bw(base_size = 16)

```
  
  
  
```{r}
  
ggplot(data = final_table) +
  geom_smooth(aes(x = consumption, y = co2_emmission)) +
  facet_wrap(~food_category, nrow = 2)
    
```
    
    
    d. A scatter plot with the sum of supply for consumption per country (x axis) and total CO2 emissions per country (y axis). Color the dots as in (a).
    
    ```{r}
    
    
    
    ```
    
    
    e. Faceted graphs: countries that start with "a"--"l" and "m"--"z".
    
    ```{r}
    ```
    
6. Store your dataset as a csv-file.
    
You work with a tibble, so use means from the `tidyverse` packages and store your data in a tibble. Data manipulations should be performed using the pipe operator. Code for 2--4 can be put in one chunk. If you need some further information, drop me an email with "hint" in it and I will provide you some. Assignment is to be handed in as an RMarkdown (you can build upon this one) and html file until 2020-07-06 via email. 

Have fun,  
Felix